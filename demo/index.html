<!doctype html>
<html>
  <head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="http://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="../dist/mamejs.js"></script>
    <link rel="stylesheet" type="text/css" href="demo.css">
  </head>
  <body>
    <div class="container">
      <h1>mamejs - Demo page</h1>
      <hr />
      <div class="row" id="main-container">
        <div class="row">
          <div id="buttons-container" class="col-xs-12"></div>
        </div>
        <div class="row">
          <div id="mame-container" class="col-xs-6 col-md-6"></div>
          <div class="control-container col-xs-6 col-md-6">
            <div id="player1controller" class="game-controller"></div>
            <div id="player2controller" class="game-controller"></div>
          </div>
        </div>
        <hr />
        <div id="gamelist-container"></div>
      </div>
    </div>
    <script type="text/x-tmpl" id="game-template">
      <button type="button" class="play-button btn btn-lg">
        <div class="glyphicon glyphicon-play-circle" aria-label="play"></div>
      </button>
      <div class="game-title"></div>
    </script>
    <script type="text/x-tmpl" id="loading-template">
      <div class="loading-container">
        <div class="loading-text">Loading %game% please wait ...</div>
      </div>
      <div class="game-container"></div>
    </script>
    <script>
      var mameContainer = document.getElementById('mame-container'),
          mainContainer = document.getElementById('main-container'),
          buttonsContainer = document.getElementById('buttons-container'),
          gamelistContainer = document.getElementById('gamelist-container'),
          gameTemplate = document.getElementById('game-template').innerHTML,
          loadingTemplate = document.getElementById('loading-template').innerHTML

      // mamejs.run config file
      var config = {
        emulator: '../dist/mame.js',
        resolution: {
          width: 320,
          height: 320
        },
        game: null, // will be updated on the fly in runGame()
      }

      // Holds the loaded mame instance on the global scope
      // just for the demo, for a simple access to the mame object
      var mame

       // launch mame game :
       // @see gamelist.json for `game` interface
      function runGame(game) {
        config.game = game

        mameContainer.innerHTML = loadingTemplate.replace('%game%', game.name)
        mameContainer.getElementsByClassName('loading-container')[0].style.backgroundImage = 'url(' + game.screenshot + ')'

        // container for mamejs
        var gameCnt = document.getElementsByClassName('game-container')[0]

        // run mame is as simple as this !
        mamejs.run(config, gameCnt).then(function(mame) {
          // this is just a demo, kiss
          // will be used by controls
          window.mame = mame

          mame.loader.on('keyup', handleMameEvent)
          mame.loader.on('keydown', handleMameEvent)

          console.log('running game ' + game.name, mame)
        }).catch(function(error) {
          console.error('error running game ' + game.name, error)
        })
      }

      function simulateKeyEvent(type, keyCode) {
        return function(evt) {
          mame.loader.simulateKeyEvent(type, keyCode, keyCode)
        }
      }

      function handleMameEvent(evt) {
        // highlight pressed button
        var buttons = document.getElementsByClassName('game-button')
        for (var i = 0, l = buttons.length; i < l ; i++) {
          var btn = buttons[i]
          if (parseInt(btn.dataset.keycode, 10) === evt.keyCode) {
            evt.type === 'keydown' ? $(btn).addClass('keydown') : $(btn).removeClass('keydown')
          }
        }
      }

      function handleButton(button, keyCode) {
        button.addEventListener('mousedown', simulateKeyEvent('keydown', keyCode))
        button.addEventListener('mouseup', simulateKeyEvent('keyup', keyCode))
      }

      function buildControllers() {
        // build visual controllers
        buildController(document.getElementById('player1controller'), mamejs.control.player1Controller)
        buildController(document.getElementById('player2controller'), mamejs.control.player2Controller)
      }

      function buildController(container, playerControler) {
        for (var bt in playerControler) {
          let keyCode = mamejs.control.Button.getKeyCode(playerControler[bt])
          let button = document.createElement('button')
          button.className = "btn btn-xs btn-default game-button game-button-" + bt + " game-button-" + playerControler[bt]
          button.dataset.keycode = keyCode

          let content = document.createElement('span')
          button.appendChild(content)

          switch (bt) {
            case 'coin':
            case 'start':
              content.innerHTML = bt
              break
            default:
              content.innerHTML = playerControler[bt]
          }

          handleButton(button, keyCode)

          container.appendChild(button)
        }
      }

      function buildGameItem(game, container) {
        var element = document.createElement('div')
        element.className = 'game-item'
        element.innerHTML = gameTemplate
        element.style.backgroundImage = 'url(' + game.screenshot + ')'
        element.getElementsByClassName('game-title')[0].innerHTML = game.name

        element.addEventListener('click', function () {
          runGame(game)
        });

        container.appendChild(element)
      }

      var gameButtons = [
        {key: mamejs.control.MameKey.PAUSE, name: 'game', glyphicon: 'pause'},
        {key: mamejs.control.MameKey.SHOW_FPS, name: 'Show FPS', glyphicon: 'film'},
      ]

      function buildGameButtons(container) {
        gameButtons.forEach(function(item) {
          let button = document.createElement('button')
          button.className = "btn-xs btn btn-default"

          if (item.glyphicon) {
            let icon = document.createElement('span')
            icon.className = 'glyphicon glyphicon-' + item.glyphicon
            button.appendChild(icon)
          }

          if (item.name) {
            let name = document.createElement('span')
            name.innerHTML = ' ' + item.name
            button.appendChild(name)
          }

          handleButton(button, mamejs.control.Button.getKeyCode(item.key));

          container.appendChild(button)
        })
      }

      function buildGamelist(gamelist) {
        gamelist.forEach(function(game, index) {
          // always append first game in the main container
          buildGameItem(game, index === 0 ? mameContainer : gamelistContainer)
        })

        // put first game at the end of the list
        buildGameItem(gamelist[0], gamelistContainer)
      }

      function main(gamelist) {
        mainContainer.style.display = 'block'
        buildGamelist(gamelist)
        buildControllers()
        buildGameButtons(buttonsContainer)
      }

      // load & init
      $.get('gamelist.json', main)
    </script>
  </body>
</html>
