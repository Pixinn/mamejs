<!doctype html>
<html>
  <head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="http://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="../dist/mamejs.js"></script>
    <link rel="stylesheet" type="text/css" href="demo.css">
  </head>
  <body>
    <div class="container">
      <h1>mamejs - Demo page</h1>
      <hr />
      <div class="row" id="main-container">
        <div class="row">
          <div id="buttons-container" class="col-xs-12"></div>
        </div>
        <div class="row">
          <div id="mame-container" class="col-xs-6 col-md-6"></div>
          <div class="control-container col-xs-6 col-md-6">
            <div id="player1controller" class="game-controller"></div>
            <div id="player2controller" class="game-controller"></div>
          </div>
        </div>
        <hr />
        <div id="gamelist-container"></div>
      </div>
    </div>
    <script type="text/x-tmpl" id="game-template">
      <button type="button" class="play-button btn btn-lg">
        <div class="glyphicon glyphicon-play-circle" aria-label="play"></div>
      </button>
      <div class="game-title"></div>
    </script>
    <script type="text/x-tmpl" id="error-template">
      <div class="panel panel-danger error-container">
        <div class="panel-heading">
          <h3 class="panel-title">Mame Error</h3>
        </div>
        <div class="panel-body error-content"></div>
      </div>
    </script>
    <script type="text/x-tmpl" id="loading-template">
      <div class="loading-container">
        <div class="loading-text">Loading %game% please wait ...</div>
      </div>
      <div class="game-container"></div>
    </script>
    <script>
      var mameContainer = document.getElementById('mame-container'),
          mainContainer = document.getElementById('main-container'),
          buttonsContainer = document.getElementById('buttons-container'),
          gamelistContainer = document.getElementById('gamelist-container'),
          controller1Container = document.getElementById('player1controller'),
          controller2Container = document.getElementById('player2controller'),
          gameTemplate = document.getElementById('game-template').innerHTML,
          loadingTemplate = document.getElementById('loading-template').innerHTML,
          errorTemplate = document.getElementById('error-template').innerHTML

      // mamejs.run config file
      var config = {
        emulator: '../dist/mame.js',
        resolution: {
          width: 320,
          height: 320
        },
        game: null, // will be updated on the fly in runGame()
      }

      // Holds the loaded mame instance on the global scope
      // just for the demo, for a simple access to the mame object
      var mame

       // launch mame game :
       // @see gamelist.json for `game` interface
      function runGame(game) {
        var cfg = JSON.parse(JSON.stringify(config)) // lazy clone
        cfg.game = game

        // special trick to use custom emulator
        cfg.emulator = game.emulator || cfg.emulator

        mameContainer.innerHTML = loadingTemplate.replace('%game%', game.name)
        mameContainer.getElementsByClassName('loading-container')[0].style.backgroundImage = 'url(' + game.screenshot + ')'

        // container for mamejs
        var gameCnt = document.getElementsByClassName('game-container')[0]

        // disable all controls prior to run a game, this will prevent error in console if button are used when mame not instanciated
        enableMameButtons(false)

        // run mame is as simple as this !
        mamejs.run(cfg, gameCnt).then(function(mame) {
          // this is just a demo, kiss
          // will be used by controls
          window.mame = mame

          onMame(mame)

          console.log('running game ' + game.name, mame)
        }).catch(function(error) {
          mameContainer.innerHTML = errorTemplate
          mameContainer.getElementsByClassName('error-content')[0].innerHTML = 'error running game ' + game.name + '<br /><br />' + error
        })
      }

      function onMame(mame) {
        mame.controls.on('keypress', function(key) {
          handleKeyboardEvent('keypress', key)
        })
        mame.controls.on('keyrelease', function(key) {
          handleKeyboardEvent('keyrelease', key)
        })

        // Handle joystick event for display / hide icons
        mame.controls.on(mamejs.control.Controls.JOYSTICKCONNECTED, function(joystick) {
          handleJoystickEvent('connected', joystick)
        })
        mame.controls.on(mamejs.control.Controls.JOYSTICKDISCONNECTED, function(joystick) {
          handleJoystickEvent('disconnected', joystick)
        })

        mame.controls.joysticks.forEach(function(joystick) {
          handleJoystickEvent('connected', joystick)
        })

        enableMameButtons(true)

        // handle errors
        var haveError = false
        var onStderr = function(text) {
          if (!haveError) {
            haveError = true
            mameContainer.innerHTML = errorTemplate

            enableMameButtons(false)
          }

          var content = document.createElement('div')
          content.innerHTML = text
          mameContainer.getElementsByClassName('error-content')[0].appendChild(content)
        }
        mame.loader.on(emloader.ON_STDERR, onStderr)
        mame.loader.stderr.forEach(onStderr)
      }

      // return the player id, actually 1 or 2 attached to the Joystick object
      function getControllerId(joystick) {
        return joystick.controller === mame.controls.player1Controller ? 1 : 2
      }

      // visual update for joystick plug / unplug
      function handleJoystickEvent(type, joystick) {
        var cnt = getControllerId(joystick) === 1 ? controller1Container : controller2Container

        // Update icon class with the good icon
        var currentIco = cnt.getElementsByClassName('keyboard-icon').length ? 'keyboard-icon' : 'gamepad-icon'
        var newIco = type === 'connected' ? 'gamepad-icon' : 'keyboard-icon'
        cnt.getElementsByClassName(currentIco)[0].className = newIco

        // also visual remap buttons visual, to display button number instead of key, and vice verca
        var buttons = cnt.getElementsByClassName('game-button')

        for (var i = 0, l = buttons.length; i < l; i++) {
          var button = buttons[i]
          if (button.dataset.button.indexOf('button') === 0) {
            // replace button name button1, button2 ... to 1, 2, 3 ...
            button.getElementsByTagName('span')[0].innerHTML = (type === 'connected' ? button.dataset.button.replace('button', '') : button.dataset.key)
          }
        }
      }

      // evt : {type : keypress|keyrelease, data: keyName}
      function handleKeyboardEvent(type, mameKey) {
        var key = mamejs.control.MameKey[mameKey]
        // highlight pressed button
        var button = document.getElementsByClassName('game-button-' + key)[0]
        type === 'keypress' ? $(button).addClass('keypress') : $(button).removeClass('keypress')
      }

      // a helper to handle button like they should work in mame
      function handleButton(button, key) {
        button.className = button.className + ' mame-button'
        button.addEventListener('mousedown', function(evt) {
          mame.controls.pressKey(key)
        })
        button.addEventListener('mouseup', function(evt) {
          mame.controls.releaseKey(key)
        })
        button.addEventListener('touch', function(evt) {
          mame.controls.keyboard.pressAndReleaseMameKey(key)
        })
      }

      function enableMameButtons(enable) {
        let buttons = document.getElementsByClassName('mame-button')
        for (var i = 0, l = buttons.length; i < l; i++) {
          buttons[i].disabled = enable ? "" : "disabled"
        }
      }

      function buildControllers() {
        // build visual controllers
        buildController(controller1Container, mamejs.control.player1Controller, 0)
        buildController(controller2Container, mamejs.control.player2Controller, 1)
      }

      function buildController(container, controller, gamepadIndex) {
        // check if have gamepad to display gamepad icon instead of keyboard icon
        // By default mamejs will handle gamepads in the same order than the getGamespads
        var gamepad = navigator.getGamepads()[gamepadIndex]

        // display the current icon controller
        let icon = document.createElement('div')
        icon.className = gamepad ? 'gamepad-icon' : 'keyboard-icon'

        container.appendChild(icon)

        for (var bt in controller) {
          let button = document.createElement('button')
          // the keyboard keyname, ex : shift, ctrl, space, a ...
          let keyName = mamejs.control.MameKey[controller[bt]]

          button.className = "btn btn-xs btn-default game-button game-button-" + bt + " game-button-" + keyName
          button.dataset.key = controller[bt] // the mame key, @see mamejs.control.MameKey
          button.dataset.button = bt // the key, ie , uparrow, a, shift ... as it's reference in playerController

          let content = document.createElement('span')
          button.appendChild(content)

          switch (bt) {
            case 'coin':
            case 'start':
              // this is just a hack to have 1, 2, 3 ... instead of digit1, digit2 ... when use game pad
              content.innerHTML = bt.replace('coin', 'insert coin') + ' (' + keyName.replace('digit', '') + ')'
              break
            default:
              content.innerHTML = gamepad ? bt.replace('button', '') : keyName
          }

          handleButton(button, controller[bt])

          container.appendChild(button)
        }
      }

      function buildGameItem(game, container) {
        var element = document.createElement('div')
        element.className = 'game-item'
        element.innerHTML = gameTemplate
        element.style.backgroundImage = 'url(' + game.screenshot + ')'
        element.getElementsByClassName('game-title')[0].innerHTML = game.name

        element.addEventListener('click', function () {
          runGame(game)
        });

        container.appendChild(element)
      }

      var gameButtons = [
        {key: mamejs.control.MameKey.PAUSE, name: 'game', glyphicon: 'pause'},
        {key: mamejs.control.MameKey.SHOW_FPS, name: 'Show FPS', glyphicon: 'film'},
      ]

      function buildGameButtons(container) {
        gameButtons.forEach(function(item) {
          let button = document.createElement('button')
          button.className = "btn-xs btn btn-default"

          if (item.glyphicon) {
            let icon = document.createElement('span')
            icon.className = 'glyphicon glyphicon-' + item.glyphicon
            button.appendChild(icon)
          }

          if (item.name) {
            let name = document.createElement('span')
            name.innerHTML = ' ' + item.name
            button.appendChild(name)
          }

          handleButton(button, item.key);

          container.appendChild(button)
        })
      }

      function buildGamelist(gamelist) {
        gamelist.forEach(function(game, index) {
          // always append first game in the main container
          buildGameItem(game, index === 0 ? mameContainer : gamelistContainer)
        })

        // put first game at the end of the list
        buildGameItem(gamelist[0], gamelistContainer)
      }

      function main(gamelist) {
        mainContainer.style.display = 'block'
        buildGamelist(gamelist)
        buildControllers()
        buildGameButtons(buttonsContainer)

        // Disable buttons during initialisation, they will be reinit on mame launched
        enableMameButtons(false)
      }

      // load & init
      $.get('gamelist.json', main)
    </script>
  </body>
</html>
